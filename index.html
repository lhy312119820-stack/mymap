<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—äº¬èƒ¡åŒç”µåŠ¨è‡ªè¡Œè½¦éª‘è¡Œè§„åˆ’å·¥å…·ï¼ˆæœ¬åœ°å¢å¼ºç‰ˆï¼‰</title>
    <!-- ç™¾åº¦åœ°å›¾APIï¼ˆå…¼å®¹æœ¬åœ°è¿è¡Œï¼Œæ·»åŠ è¶…æ—¶å…œåº•ï¼‰ -->
    <script type="text/javascript">
        // æœ¬åœ°è¿è¡Œé€‚é…ï¼šæå‰åŠ è½½ç™¾åº¦åœ°å›¾ï¼Œæ·»åŠ é”™è¯¯æ•è·
        window.BMapGL_loadScript = function() {
            const script = document.createElement('script');
            script.src = 'https://api.map.baidu.com/api?v=3.0&ak=zrrJu1HOoPufu4x54Fzb89yEO703iSrG&s=1';
            script.onerror = function() {
                window.BMapGL = { error: 'åŠ è½½å¤±è´¥' };
                console.log('ç™¾åº¦åœ°å›¾APIåŠ è½½å¤±è´¥ï¼Œå°†å¯ç”¨çº¯åˆ—è¡¨æ¨¡å¼');
            };
            document.head.appendChild(script);
        };
        BMapGL_loadScript();
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Microsoft YaHei", sans-serif; background: #f8f9fa; }
        .container { display: flex; height: 100vh; flex-direction: column; max-width: 100vw; overflow: hidden; }
        /* å“åº”å¼å¸ƒå±€ä¼˜åŒ– */
        @media (min-width: 768px) {
            .container { flex-direction: row; }
        }
        .sidebar { 
            width: 100%; 
            max-width: 400px; 
            background: #fff; 
            padding: 20px; 
            overflow-y: auto; 
            height: 40vh;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        @media (min-width: 768px) {
            .sidebar { height: 100vh; border-right: 1px solid #eee; }
        }
        .map-container { flex: 1; height: 60vh; position: relative; }
        @media (min-width: 768px) {
            .map-container { height: 100vh; }
        }
        /* æ ·å¼å¢å¼º */
        .title { 
            font-size: 22px; 
            font-weight: bold; 
            margin-bottom: 15px; 
            color: #2f54eb;
            border-bottom: 2px solid #f0f5ff;
            padding-bottom: 10px;
        }
        .filter-box { 
            margin-bottom: 20px; 
            padding: 15px;
            background: #f9fafe;
            border-radius: 8px;
        }
        .filter-title { 
            font-size: 16px; 
            font-weight: bold; 
            margin-bottom: 12px; 
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-title::before {
            content: "";
            display: inline-block;
            width: 4px;
            height: 16px;
            background: #2f54eb;
            border-radius: 2px;
        }
        .filter-btn { 
            padding: 8px 15px; 
            margin: 0 8px 8px 0; 
            border: 1px solid #e5e6eb;
            border-radius: 6px; 
            background: #fff; 
            cursor: pointer; 
            transition: all 0.2s;
            font-size: 14px;
        }
        .filter-btn:hover {
            border-color: #c9cdde;
            background: #f5f7fa;
        }
        .filter-btn.active { 
            background: #2f54eb; 
            color: #fff;
            border-color: #2f54eb;
        }
        .alley-list { margin-bottom: 20px; }
        .alley-item { 
            padding: 15px; 
            background: #fff; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            cursor: pointer; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); 
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        .alley-item:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
        }
        .alley-item.selected { 
            border-left: 4px solid #2f54eb; 
            background: #f0f5ff;
        }
        .alley-name { 
            font-weight: bold; 
            margin-bottom: 6px; 
            display: flex; 
            justify-content: space-between; 
            flex-wrap: wrap;
            font-size: 15px;
        }
        .alley-tag { 
            font-size: 12px; 
            color: #666; 
            margin-bottom: 6px; 
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .alley-tag span {
            background: #f5f7fa;
            padding: 2px 8px;
            border-radius: 4px;
        }
        .alley-info { 
            font-size: 12px; 
            color: #888; 
            line-height: 1.5;
        }
        .allow-ebike { color: #00b42a; font-weight: normal; }
        .forbid-ebike { color: #f53f3f; font-weight: normal; }
        .btn-group { 
            display: flex; 
            gap: 10px; 
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .btn { 
            flex: 1; 
            padding: 12px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.3s;
            font-size: 14px;
        }
        .btn-primary { 
            background: #2f54eb; 
            color: #fff; 
        }
        .btn-primary:hover { 
            background: #1d47d9; 
            transform: translateY(-1px);
        }
        .btn-default { 
            background: #fff; 
            color: #333; 
            border: 1px solid #e5e6eb;
        }
        .btn-default:hover { 
            background: #f5f7fa;
            border-color: #c9cdde;
        }
        .tip-text { 
            font-size: 12px; 
            color: #999; 
            margin-top: 10px; 
            text-align: center; 
        }
        .error-tip { 
            color: #f53f3f; 
            font-size: 12px; 
            margin: 10px 0; 
            text-align: left; 
            padding: 10px; 
            background: #fff0f0; 
            border-radius: 6px;
            border-left: 4px solid #f53f3f;
        }
        .local-tip { 
            font-size: 12px; 
            color: #2f54eb; 
            margin: 10px 0 20px; 
            text-align: left; 
            padding: 10px; 
            background: #f0f5ff; 
            border-radius: 6px;
            border-left: 4px solid #2f54eb;
        }
        /* åœ°å›¾åŠ è½½å ä½ */
        .map-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        .map-placeholder p {
            color: #666;
            font-size: 14px;
            margin-top: 15px;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e6eb;
            border-top: 4px solid #2f54eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* é€‰ä¸­åˆ—è¡¨è®¡æ•° */
        .selected-count {
            font-size: 12px;
            color: #2f54eb;
            margin: 10px 0;
            padding: 8px;
            background: #f0f5ff;
            border-radius: 4px;
            text-align: center;
        }
        /* æ–°å¢ï¼šæœç´¢æ¡†æ ·å¼ */
        .search-box {
            margin-bottom: 20px;
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            border: 1px solid #e5e6eb;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }
        .search-input:focus {
            border-color: #2f54eb;
            box-shadow: 0 0 0 2px rgba(47, 84, 235, 0.1);
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 16px;
        }
        /* æ–°å¢ï¼šè·¯çº¿ä¿¡æ¯å¼¹çª— */
        .route-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
            display: none;
        }
        .route-popup-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2f54eb;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .route-popup-content {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        .route-popup-close {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            font-size: 18px;
            color: #999;
        }
        .route-popup-close:hover {
            color: #f53f3f;
        }
        .route-popup-btn {
            text-align: center;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        /* æ–°å¢ï¼šç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 767px) {
            .sidebar {
                height: 50vh;
            }
            .map-container {
                height: 50vh;
            }
            .filter-btn {
                padding: 6px 10px;
                font-size: 13px;
            }
            .alley-item {
                padding: 10px;
            }
            .btn {
                padding: 10px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="title">åŒ—äº¬èƒ¡åŒéª‘è¡Œè§„åˆ’å·¥å…·ï¼ˆæœ¬åœ°å¢å¼ºç‰ˆï¼‰</div>
            
            <!-- æœ¬åœ°è¿è¡Œæç¤º -->
            <div class="local-tip">ğŸ’¡ æœ¬åœ°è¿è¡Œæ¨¡å¼å·²å¼€å¯ï¼Œæ— éœ€é…ç½®åŸŸåï¼Œæ”¯æŒç¦»çº¿æµè§ˆèƒ¡åŒä¿¡æ¯</div>
            
            <!-- é”™è¯¯æç¤ºåŒºåŸŸ -->
            <div class="error-tip" id="errorTip" style="display: none;"></div>
            
            <!-- æ–°å¢ï¼šæœç´¢æ¡† -->
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢èƒ¡åŒåç§°/ç‰¹è‰²/åŒºåŸŸ...">
            </div>
            
            <!-- é€‰ä¸­è®¡æ•° -->
            <div class="selected-count" id="selectedCount">å·²é€‰æ‹©ï¼š0 æ¡èƒ¡åŒï¼ˆè‡³å°‘é€‰æ‹©2æ¡å¯ç”Ÿæˆè·¯çº¿ï¼‰</div>
            
            <!-- ç­›é€‰åŒºåŸŸ -->
            <div class="filter-box">
                <div class="filter-title">åŒºåŸŸç­›é€‰</div>
                <button class="filter-btn active" data-area="all">å…¨éƒ¨åŒºåŸŸ</button>
                <button class="filter-btn" data-area="dongcheng">ä¸œåŸåŒº</button>
                <button class="filter-btn" data-area="xicheng">è¥¿åŸåŒº</button>
                <button class="filter-btn" data-area="shijingshan">çŸ³æ™¯å±±åŒº</button>
                <button class="filter-btn" data-area="haidian">æµ·æ·€åŒº</button>
                <button class="filter-btn" data-area="chaoyang">æœé˜³åŒº</button>
                <button class="filter-btn" data-area="fengtai">ä¸°å°åŒº</button>
                <button class="filter-btn" data-area="tongzhou">é€šå·åŒº</button>
            </div>
            
            <div class="filter-box">
                <div class="filter-title">ç‰¹è‰²ç­›é€‰</div>
                <button class="filter-btn active" data-tag="all">å…¨éƒ¨ç‰¹è‰²</button>
                <button class="filter-btn" data-tag="å†å²">å†å²æ–‡åŒ–</button>
                <button class="filter-btn" data-tag="ç¾é£Ÿ">ç‰¹è‰²ç¾é£Ÿ</button>
                <button class="filter-btn" data-tag="ç½‘çº¢">ç½‘çº¢æ‰“å¡</button>
                <button class="filter-btn" data-tag="å®‰é™">å°ä¼—å®‰é™</button>
                <button class="filter-btn" data-tag="å¤å¤">å¤å¤å»ºç­‘</button>
            </div>
            
            <div class="filter-box">
                <div class="filter-title">ç”µåŠ¨è½¦å¯è¾¾</div>
                <button class="filter-btn active" data-ebike="all">å…¨éƒ¨</button>
                <button class="filter-btn" data-ebike="allow">å…è®¸é€šè¡Œ</button>
                <button class="filter-btn" data-ebike="forbid">ç¦æ­¢é€šè¡Œ</button>
            </div>
            
            <div class="alley-list" id="alleyList"></div>
            
            <div class="btn-group">
                <button class="btn btn-default" id="clearBtn">æ¸…ç©ºé€‰æ‹©</button>
                <button class="btn btn-primary" id="routeBtn">ç”Ÿæˆéª‘è¡Œè·¯çº¿</button>
                <button class="btn btn-primary" id="navBtn">å¯¼èˆªå‡ºå‘</button>
            </div>
            
            <div class="tip-text">æç¤ºï¼šæ ‡æ³¨"ç¦æ­¢é€šè¡Œ"çš„èƒ¡åŒå¯å°†ç”µåŠ¨è½¦åœåœ¨å…¥å£å¤„æ­¥è¡Œè¿›å…¥</div>
        </div>
        
        <div class="map-container" id="map">
            <!-- åœ°å›¾åŠ è½½å ä½ -->
            <div class="map-placeholder" id="mapPlaceholder">
                <div class="loading-spinner"></div>
                <p>æ­£åœ¨åŠ è½½åœ°å›¾ï¼Œè¯·ç¨å€™...</p>
                <p style="font-size: 12px; color: #999;">æœ¬åœ°è¿è¡Œå¯èƒ½éœ€è¦å‡ ç§’æ—¶é—´</p>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šè·¯çº¿ä¿¡æ¯å¼¹çª— -->
    <div class="overlay" id="overlay"></div>
    <div class="route-popup" id="routePopup">
        <span class="route-popup-close" id="popupClose">Ã—</span>
        <div class="route-popup-title">éª‘è¡Œè·¯çº¿è¯¦æƒ…</div>
        <div class="route-popup-content" id="routeContent"></div>
        <div class="route-popup-btn">
            <button class="btn btn-primary" id="copyRouteBtn">å¤åˆ¶è·¯çº¿ä¿¡æ¯</button>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–DOMå…ƒç´ 
        const errorTip = document.getElementById("errorTip");
        const mapPlaceholder = document.getElementById("mapPlaceholder");
        const selectedCount = document.getElementById("selectedCount");
        const searchInput = document.getElementById("searchInput");
        const routePopup = document.getElementById("routePopup");
        const overlay = document.getElementById("overlay");
        const popupClose = document.getElementById("popupClose");
        const routeContent = document.getElementById("routeContent");
        const copyRouteBtn = document.getElementById("copyRouteBtn");
        let mapLoaded = false;
        let map = null;
        let selectedAlleys = [];
        let markers = [];
        let polyline = null;

        // èƒ¡åŒæ•°æ®ï¼ˆå®Œæ•´40+æ¡ï¼‰
        const alleyData = [
            // ä¸œåŸåŒºï¼ˆ10æ¡ï¼‰
            { name: "å—é”£é¼“å··", lng: 116.408, lat: 39.932, area: "dongcheng", tag: "ç½‘çº¢|ç¾é£Ÿ", ebike: "forbid", shootTime: "10:00-16:00", park: "èƒ¡åŒä¸¤ç«¯å…¥å£åœè½¦åœº", desc: "åŒ—äº¬æœ€çŸ¥åèƒ¡åŒï¼Œç½‘çº¢æ‰“å¡+ç‰¹è‰²å°åƒèšé›†åœ°ï¼Œæ ¸å¿ƒåŒºåŸŸç¦æ­¢ç”µåŠ¨è½¦" },
            { name: "äº”é“è¥èƒ¡åŒ", lng: 116.415, lat: 39.935, area: "dongcheng", tag: "å°ä¼—|ç¾é£Ÿ", ebike: "allow", shootTime: "9:00-17:00", park: "èƒ¡åŒåŒ—å£è·¯è¾¹åœè½¦åŒº", desc: "æ–‡è‰ºå°ä¼—èƒ¡åŒï¼Œå’–å•¡é¦†ã€æ–‡åˆ›åº—å¯†é›†ï¼Œäººå°‘å®‰é™ï¼Œç”µåŠ¨è½¦å¯é€šè¡Œ" },
            { name: "å›½å­ç›‘è¡—", lng: 116.423, lat: 39.938, area: "dongcheng", tag: "å†å²|å®‰é™", ebike: "allow", shootTime: "8:30-16:30", park: "å­”åº™è¥¿é—¨åœè½¦åœº", desc: "ç´§é‚»å›½å­ç›‘ã€å­”åº™ï¼Œå¤è‰²å¤é¦™ï¼Œæ–‡åŒ–æ°›å›´æµ“åš" },
            { name: "ä¸œäº¤æ°‘å··", lng: 116.417, lat: 39.907, area: "dongcheng", tag: "å†å²|å¤å¤", ebike: "allow", shootTime: "14:00-18:00", park: "å··å†…å¤šå¤„è·¯è¾¹åœè½¦ç‚¹", desc: "æœ€é•¿çš„èƒ¡åŒï¼Œè¿‘ä»£è¥¿æ´‹å»ºç­‘ï¼Œé€‚åˆå¤å¤é£æ‹æ‘„" },
            { name: "èŠå„¿èƒ¡åŒ", lng: 116.410, lat: 39.934, area: "dongcheng", tag: "å†å²|å®‰é™", ebike: "allow", shootTime: "10:00-15:00", park: "èƒ¡åŒä¸œå£åœè½¦åŒº", desc: "ä¼ ç»Ÿå››åˆé™¢é›†ä¸­åœ°ï¼Œå»ºç­‘é£æ ¼ç‹¬ç‰¹ï¼Œé€‚åˆæ‹ç…§" },
            { name: "å¸½å„¿èƒ¡åŒ", lng: 116.409, lat: 39.936, area: "dongcheng", tag: "å†å²|å®‰é™", ebike: "allow", shootTime: "9:30-16:00", park: "èƒ¡åŒå—å£åœè½¦åŒº", desc: "å››åˆé™¢ä¿æŠ¤åŒºï¼Œæœ‰å©‰å®¹æ•…å±…ï¼Œç¯å¢ƒæ¸…å¹½" },
            { name: "åŒ—é”£é¼“å··", lng: 116.406, lat: 39.937, area: "dongcheng", tag: "å®‰é™|å°ä¼—", ebike: "allow", shootTime: "10:00-17:00", park: "å··å£è·¯è¾¹åœè½¦ç‚¹", desc: "å—é”£é¼“å··å§å¦¹å··ï¼Œäººå°‘æ¸…é™ï¼Œæ–‡è‰ºå°åº—å¤š" },
            { name: "å—å‰ªå­å··", lng: 116.412, lat: 39.928, area: "dongcheng", tag: "å†å²|å®‰é™", ebike: "allow", shootTime: "8:30-15:30", park: "å··å£åœè½¦åŒº", desc: "ç´§é‚»ç‹åºœäº•ï¼Œè€åŒ—äº¬å±…æ°‘åŒºï¼Œä¿ç•™ä¼ ç»Ÿé£è²Œ" },
            { name: "ç¯å¸‚å£åŒ—å··", lng: 116.419, lat: 39.925, area: "dongcheng", tag: "ç½‘çº¢|æ–‡è‰º", ebike: "allow", shootTime: "11:00-18:00", park: "ç¯å¸‚å£å¤§è¡—åœè½¦åœº", desc: "æ½®æµå°åº—èšé›†åœ°ï¼Œé€‚åˆæ—¶å°švlogæ‹æ‘„" },
            { name: "è‰å‚èƒ¡åŒ", lng: 116.428, lat: 39.912, area: "dongcheng", tag: "å¤å¤|å®‰é™", ebike: "allow", shootTime: "9:00-16:00", park: "èƒ¡åŒè¥¿å£åœè½¦åŒº", desc: "å‰é—¨é™„è¿‘ï¼Œä¼ ç»Ÿå››åˆé™¢å¯†é›†ï¼Œå¤å¤é£æ‹æ‘„ç»ä½³" },
            
            // è¥¿åŸåŒºï¼ˆ10æ¡ï¼‰
            { name: "çƒŸè¢‹æ–œè¡—", lng: 116.397, lat: 39.939, area: "xicheng", tag: "å†å²|ç¾é£Ÿ", ebike: "forbid", shootTime: "11:00-17:00", park: "é¼“æ¥¼ä¸œå¤§è¡—åœè½¦åœº", desc: "è¿æ¥ä»€åˆ¹æµ·ä¸é¼“æ¥¼ï¼Œæ˜æ¸…é£æ ¼å»ºç­‘ï¼Œç‰¹è‰²å°åº—å¤š" },
            { name: "ä»€åˆ¹æµ·èƒ¡åŒç¾¤", lng: 116.392, lat: 39.943, area: "xicheng", tag: "å†å²|ç½‘çº¢", ebike: "allow", shootTime: "15:00-20:00", park: "åæµ·åŒ—æ²¿åœè½¦åŒº", desc: "å›´ç»•ä»€åˆ¹æµ·ï¼Œå«é“¶é”­æ¡¥ã€åæµ·åŒ—æ²¿ç­‰ï¼Œå¤œæ™¯ç¾" },
            { name: "æ¨æ¢…ç«¹æ–œè¡—", lng: 116.391, lat: 39.917, area: "xicheng", tag: "ç½‘çº¢|æ–‡è‰º", ebike: "allow", shootTime: "10:00-18:00", park: "å‰é—¨è¥¿å¤§è¡—åœè½¦åœº", desc: "å‰é—¨é™„è¿‘ï¼Œæ–‡è‰ºå°åº—ã€ä¹¦åº—ã€ç¾æœ¯é¦†èšé›†åœ°" },
            { name: "æŠ¤å›½å¯ºè¡—", lng: 116.386, lat: 39.931, area: "xicheng", tag: "ç¾é£Ÿ|å†å²", ebike: "allow", shootTime: "11:00-19:00", park: "è¡—ä¸¤ç«¯è·¯è¾¹åœè½¦ç‚¹", desc: "è€åŒ—äº¬ç¾é£Ÿè¡—ï¼ŒæŠ¤å›½å¯ºå°åƒã€çƒ¤è‚‰å­£ç­‰è€å­—å·" },
            { name: "ç‰ç’ƒå‚è¥¿è¡—", lng: 116.382, lat: 39.914, area: "xicheng", tag: "å†å²|å¤å¤", ebike: "allow", shootTime: "9:00-16:30", park: "è¡—å—å£åœè½¦åœº", desc: "æ–‡åŒ–ä¸€æ¡è¡—ï¼Œæ–‡æˆ¿å››å®ã€å¤ç©å­—ç”»åº—å¯†é›†ï¼Œå¤è‰²å¤é¦™" },
            { name: "å¤§æ …æ è¥¿è¡—", lng: 116.386, lat: 39.907, area: "xicheng", tag: "ç½‘çº¢|ç¾é£Ÿ", ebike: "forbid", shootTime: "10:00-19:00", park: "å¤§æ …æ åœè½¦åœº", desc: "å‰é—¨æ ¸å¿ƒåŒºåŸŸï¼Œè€å­—å·èšé›†åœ°ï¼Œç¦æ­¢ç”µåŠ¨è½¦é€šè¡Œ" },
            { name: "ç –å¡”èƒ¡åŒ", lng: 116.384, lat: 39.926, area: "xicheng", tag: "å†å²|å®‰é™", ebike: "allow", shootTime: "9:30-16:30", park: "èƒ¡åŒä¸œå£åœè½¦åŒº", desc: "åŒ—äº¬æœ€å¤è€çš„èƒ¡åŒä¹‹ä¸€ï¼Œä¿ç•™ä¼ ç»Ÿé£è²Œ" },
            { name: "æœˆå›åŒ—è¡—", lng: 116.358, lat: 39.927, area: "xicheng", tag: "å®‰é™|å°ä¼—", ebike: "allow", shootTime: "10:00-17:00", park: "è¡—ä¸¤ç«¯åœè½¦ç‚¹", desc: "æœˆå›å…¬å›­é™„è¿‘ï¼Œå±…æ°‘åŒºèƒ¡åŒï¼Œäººå°‘æ¸…é™" },
            { name: "å¾·èƒœé—¨å†…å¤§è¡—èƒ¡åŒç¾¤", lng: 116.375, lat: 39.945, area: "xicheng", tag: "å†å²|ç¾é£Ÿ", ebike: "allow", shootTime: "11:00-18:00", park: "å¾·èƒœé—¨è¥¿å¤§è¡—åœè½¦åœº", desc: "å›´ç»•å¾·èƒœé—¨ï¼Œè€åŒ—äº¬å°åƒåº—ã€å››åˆé™¢å¯†é›†" },
            { name: "å—å®˜æˆ¿èƒ¡åŒ", lng: 116.390, lat: 39.941, area: "xicheng", tag: "ç½‘çº¢|å®‰é™", ebike: "allow", shootTime: "14:00-19:00", park: "åæµ·å…¬å›­åœè½¦åŒº", desc: "ä»€åˆ¹æµ·é™„è¿‘ï¼Œæ–‡è‰ºå°åº—ã€å’–å•¡é¦†å¤šï¼Œå¤œæ™¯ç¾" },
            
            // çŸ³æ™¯å±±åŒºï¼ˆ8æ¡ï¼‰
            { name: "æ¨¡å¼å£å¤§è¡—", lng: 116.198, lat: 39.975, area: "shijingshan", tag: "å†å²|å¤å¤", ebike: "allow", shootTime: "9:00-17:00", park: "å¤§è¡—ä¸œå£åœè½¦åœº", desc: "äº¬è¥¿å¤é“èµ·ç‚¹ï¼Œæ˜æ¸…å»ºç­‘ä¿å­˜å®Œå¥½ï¼Œæœ‰æ³•æµ·å¯ºã€æ‰¿æ©å¯º" },
            { name: "äº”é‡Œå¨èƒ¡åŒç¾¤", lng: 116.152, lat: 39.986, area: "shijingshan", tag: "å®‰é™|å°ä¼—", ebike: "allow", shootTime: "8:30-16:00", park: "äº”é‡Œå¨è·¯è·¯è¾¹åœè½¦åŒº", desc: "åŸç”Ÿæ€èƒ¡åŒï¼Œäººå°‘æ¸…é™ï¼Œä¿ç•™è€åŒ—äº¬ä¹¡æ‘é£è²Œ" },
            { name: "éº»å³ªèƒ¡åŒ", lng: 116.135, lat: 39.947, area: "shijingshan", tag: "å†å²|å®‰é™", ebike: "allow", shootTime: "10:00-15:00", park: "éº»å³ªä¸œè¡—åœè½¦ç‚¹", desc: "ç´§é‚»æ°¸å®šæ²³ï¼Œèƒ¡åŒç‹­çª„å¹½æ·±ï¼Œæœ‰è€å‚æˆ¿æ”¹é€ æ–‡åˆ›ç©ºé—´" },
            { name: "é‡‘é¡¶è¡—èƒ¡åŒ", lng: 116.223, lat: 39.968, area: "shijingshan", tag: "ç¾é£Ÿ|å°ä¼—", ebike: "allow", shootTime: "11:00-18:00", park: "é‡‘é¡¶è¡—è·¯å£åœè½¦åŒº", desc: "è€ç¤¾åŒºèƒ¡åŒï¼Œè—ç€å¤šå®¶çŸ³æ™¯å±±ç‰¹è‰²å°åƒåº—" },
            { name: "å¤åŸèƒ¡åŒ", lng: 116.245, lat: 39.942, area: "shijingshan", tag: "å¤å¤|å®‰é™", ebike: "allow", shootTime: "9:30-16:30", park: "å¤åŸå¤§è¡—åœè½¦åœº", desc: "ç´§é‚»å¤åŸåœ°é“ç«™ï¼Œè€åŒ—äº¬èƒ¡åŒä¸ç°ä»£å»ºç­‘äº¤è" },
            { name: "å¹¿å®æ‘èƒ¡åŒ", lng: 116.118, lat: 39.962, area: "shijingshan", tag: "å®‰é™|å°ä¼—", ebike: "allow", shootTime: "8:30-15:30", park: "å¹¿å®è·¯åœè½¦åŒº", desc: "äº¬è¥¿åè¿œèƒ¡åŒï¼ŒåŸç”Ÿæ€é£è²Œï¼Œå‡ ä¹æ— æ¸¸å®¢" },
            { name: "è‹¹æœå›­èƒ¡åŒ", lng: 116.205, lat: 39.958, area: "shijingshan", tag: "æ–‡è‰º|å°ä¼—", ebike: "allow", shootTime: "10:00-17:00", park: "è‹¹æœå›­åœ°é“ç«™åœè½¦åœº", desc: "è€å·¥ä¸šåŒºæ”¹é€ ï¼Œæ–‡åˆ›ç©ºé—´ã€å’–å•¡é¦†å¤šï¼Œé€‚åˆå·¥ä¸šé£æ‹æ‘„" },
            { name: "å…«è§’åŒ—è·¯èƒ¡åŒ", lng: 116.248, lat: 39.927, area: "shijingshan", tag: "ç¾é£Ÿ|å®‰é™", ebike: "allow", shootTime: "11:00-18:00", park: "å…«è§’æ¸¸ä¹å›­åœè½¦åŒº", desc: "å±…æ°‘åŒºèƒ¡åŒï¼Œç‰¹è‰²å®¶å¸¸èœé¦†ã€å°åƒåº—å¯†é›†" },
            
            // æµ·æ·€åŒºï¼ˆ6æ¡ï¼‰
            { name: "è‹å·è¡—", lng: 116.318, lat: 39.982, area: "haidian", tag: "å†å²|ç¾é£Ÿ", ebike: "allow", shootTime: "10:00-18:00", park: "è¡—ä¸¤ç«¯åœè½¦åŒº", desc: "æ˜æ¸…çš‡å®¶å¾¡é“ï¼Œç°åœ¨æ˜¯ç¾é£Ÿè¡—ï¼Œç´§é‚»é¢å’Œå›­" },
            { name: "æˆåºœè·¯èƒ¡åŒç¾¤", lng: 116.338, lat: 40.003, area: "haidian", tag: "æ–‡è‰º|å®‰é™", ebike: "allow", shootTime: "14:00-20:00", park: "äº”é“å£åœ°é“ç«™åœè½¦åœº", desc: "å›´ç»•æ¸…åã€åŒ—å¤§ï¼Œæ–‡è‰ºæ°›å›´æµ“åšï¼Œå’–å•¡é¦†ã€ä¹¦åº—å¤š" },
            { name: "é¢å’Œå›­è·¯èƒ¡åŒ", lng: 116.305, lat: 39.992, area: "haidian", tag: "å†å²|å¤å¤", ebike: "allow", shootTime: "9:00-16:30", park: "é¢å’Œå›­ä¸œå®«é—¨åœè½¦åœº", desc: "ç´§é‚»é¢å’Œå›­ï¼Œå¤è‰²å¤é¦™ï¼Œçš‡å®¶å›­æ—å‘¨è¾¹é£è²Œ" },
            { name: "æ¸…åå›­èƒ¡åŒ", lng: 116.332, lat: 40.009, area: "haidian", tag: "å®‰é™|æ–‡è‰º", ebike: "allow", shootTime: "10:00-17:00", park: "æ¸…åå¤§å­¦è¥¿é—¨åœè½¦åœº", desc: "æ¸…åå›­å‘¨è¾¹ï¼Œå­¦æœ¯æ°›å›´æµ“åšï¼Œå®‰é™æ•´æ´" },
            { name: "æµ·æ·€é»„åº„èƒ¡åŒ", lng: 116.328, lat: 39.988, area: "haidian", tag: "ç½‘çº¢|ç¾é£Ÿ", ebike: "allow", shootTime: "11:00-19:00", park: "æµ·æ·€é»„åº„åœ°é“ç«™åœè½¦åœº", desc: "é«˜æ ¡èšé›†åŒºï¼Œç½‘çº¢ç¾é£Ÿã€æ½®æµå°åº—å¤š" },
            { name: "è¥¿å±±è„šä¸‹èƒ¡åŒç¾¤", lng: 116.275, lat: 39.995, area: "haidian", tag: "å®‰é™|å°ä¼—", ebike: "allow", shootTime: "8:30-16:00", park: "è¥¿å±±æ£®æ—å…¬å›­åœè½¦åŒº", desc: "è¥¿å±±è„šä¸‹ï¼ŒåŸç”Ÿæ€èƒ¡åŒï¼Œè‡ªç„¶é£æ™¯ä¼˜ç¾" },
            
            // æœé˜³åŒºï¼ˆ6æ¡ï¼‰
            { name: "ä¸‰é‡Œå±¯åŒ—å°è¡—", lng: 116.465, lat: 39.938, area: "chaoyang", tag: "ç½‘çº¢|æ–‡è‰º", ebike: "allow", shootTime: "15:00-21:00", park: "ä¸‰é‡Œå±¯SOHOåœè½¦åœº", desc: "æ½®æµå°åº—èšé›†åœ°ï¼Œé€‚åˆæ‹æ‘„æ—¶å°šã€æ–‡è‰ºvlog" },
            { name: "äº”é“è¥èƒ¡åŒï¼ˆæœé˜³åˆ†å··ï¼‰", lng: 116.432, lat: 39.941, area: "chaoyang", tag: "å°ä¼—|å®‰é™", ebike: "allow", shootTime: "10:00-17:00", park: "å··å£è·¯è¾¹åœè½¦ç‚¹", desc: "ä¸œåŸåŒºäº”é“è¥èƒ¡åŒå»¶ä¼¸ï¼Œäººå°‘æ¸…é™ï¼Œæ–‡åˆ›åº—å¤š" },
            { name: "å›½å­ç›‘è¡—ï¼ˆæœé˜³æ®µï¼‰", lng: 116.429, lat: 39.939, area: "chaoyang", tag: "å†å²|å®‰é™", ebike: "allow", shootTime: "9:00-16:30", park: "é›å’Œå®«åœ°é“ç«™åœè½¦åœº", desc: "ç´§é‚»é›å’Œå®«ï¼Œæ–‡åŒ–æ°›å›´æµ“åšï¼Œå¤è‰²å¤é¦™" },
            { name: "å·¥äººä½“è‚²åœºåŒ—è·¯èƒ¡åŒ", lng: 116.458, lat: 39.936, area: "chaoyang", tag: "ç½‘çº¢|æ—¶å°š", ebike: "allow", shootTime: "16:00-22:00", park: "å·¥äººä½“è‚²åœºåœè½¦åœº", desc: "æ½®æµèšé›†åœ°ï¼Œé…’å§ã€é¤å…å¤šï¼Œå¤œæ™¯ç¹å" },
            { name: "é’å¹´è·¯èƒ¡åŒ", lng: 116.492, lat: 39.928, area: "chaoyang", tag: "ç¾é£Ÿ|ç½‘çº¢", ebike: "allow", shootTime: "11:00-19:00", park: "é’å¹´è·¯åœ°é“ç«™åœè½¦åœº", desc: "å±…æ°‘åŒºå‘¨è¾¹ï¼Œç½‘çº¢ç¾é£Ÿã€ç‰¹è‰²å°åº—å¤š" },
            { name: "å­™æ²³ä¹¡èƒ¡åŒç¾¤", lng: 116.578, lat: 39.992, area: "chaoyang", tag: "å®‰é™|å°ä¼—", ebike: "allow", shootTime: "9:00-16:00", park: "å­™æ²³åœ°é“ç«™åœè½¦åŒº", desc: "è¿‘éƒŠåŸç”Ÿæ€èƒ¡åŒï¼Œäººå°‘æ¸…é™ï¼Œè‡ªç„¶é£è²Œå¥½" },
            
            // ä¸°å°åŒºï¼ˆ5æ¡ï¼‰
            { name: "å®›å¹³åŸèƒ¡åŒç¾¤", lng: 116.238, lat: 39.867, area: "fengtai", tag: "å†å²|å¤å¤", ebike: "allow", shootTime: "9:00-16:00", park: "å®›å¹³åŸä¸œé—¨åœè½¦åœº", desc: "æ˜æ¸…å¤åŸï¼Œä¿ç•™å®Œæ•´åŸå¢™ï¼Œèƒ¡åŒå†…æœ‰æŠ—æˆ˜çºªå¿µé¦†" },
            { name: "å¤§äº•èƒ¡åŒ", lng: 116.245, lat: 39.889, area: "fengtai", tag: "ç¾é£Ÿ|å°ä¼—", ebike: "allow", shootTime: "11:00-19:00", park: "å¤§äº•è·¯åœè½¦åŒº", desc: "è€åŒ—äº¬ç¤¾åŒºèƒ¡åŒï¼Œç‰¹è‰²å¤ç…®ã€ç‚’è‚åº—èšé›†åœ°" },
            { name: "å³å®‰é—¨èƒ¡åŒ", lng: 116.352, lat: 39.882, area: "fengtai", tag: "å†å²|å®‰é™", ebike: "allow", shootTime: "9:30-16:30", park: "å³å®‰é—¨åœ°é“ç«™åœè½¦åœº", desc: "å—åŸè€èƒ¡åŒï¼Œä¿ç•™ä¼ ç»Ÿæ°‘å±…é£è²Œ" },
            { name: "èŠ±ä¹¡èƒ¡åŒ", lng: 116.348, lat: 39.847, area: "fengtai", tag: "å®‰é™|å°ä¼—", ebike: "allow", shootTime: "8:30-15:30", park: "èŠ±ä¹¡åœ°é“ç«™åœè½¦åŒº", desc: "è¿‘éƒŠèƒ¡åŒï¼ŒèŠ±å‰ç§æ¤åŸºåœ°å‘¨è¾¹ï¼Œç¯å¢ƒä¼˜ç¾" },
            { name: "å¢æ²Ÿæ¡¥èƒ¡åŒ", lng: 116.225, lat: 39.862, area: "fengtai", tag: "å†å²|å¤å¤", ebike: "allow", shootTime: "9:00-17:00", park: "å¢æ²Ÿæ¡¥æ™¯åŒºåœè½¦åœº", desc: "å¢æ²Ÿæ¡¥å‘¨è¾¹ï¼Œæ˜æ¸…å»ºç­‘å¤šï¼Œå†å²æ°›å›´æµ“åš" },
            
            // é€šå·åŒºï¼ˆ5æ¡ï¼‰
            { name: "è¥¿æµ·å­èƒ¡åŒ", lng: 116.658, lat: 39.912, area: "tongzhou", tag: "å†å²|å®‰é™", ebike: "allow", shootTime: "8:30-16:30", park: "è¥¿æµ·å­å…¬å›­åœè½¦åœº", desc: "ç´§é‚»è¥¿æµ·å­å…¬å›­ï¼Œè¿æ²³æ–‡åŒ–æµ“åšï¼Œèƒ¡åŒå¹½é™" },
            { name: "å—å¤§è¡—èƒ¡åŒç¾¤", lng: 116.652, lat: 39.907, area: "tongzhou", tag: "å¤å¤|ç¾é£Ÿ", ebike: "allow", shootTime: "10:00-18:00", park: "å—å¤§è¡—è·¯å£åœè½¦åŒº", desc: "é€šå·è€åŸåŒºæ ¸å¿ƒï¼Œæ˜æ¸…å»ºç­‘å¤šï¼Œç‰¹è‰²å°åƒä¸°å¯Œ" },
            { name: "æ–°åå¤§è¡—èƒ¡åŒ", lng: 116.665, lat: 39.915, area: "tongzhou", tag: "ç½‘çº¢|æ–‡è‰º", ebike: "allow", shootTime: "11:00-19:00", park: "é€šå·ä¸‡è¾¾å¹¿åœºåœè½¦åœº", desc: "é€šå·æ ¸å¿ƒåŒºï¼Œæ½®æµå°åº—ã€æ–‡åˆ›ç©ºé—´å¤š" },
            { name: "å¼ å®¶æ¹¾èƒ¡åŒç¾¤", lng: 116.758, lat: 39.892, area: "tongzhou", tag: "å†å²|å®‰é™", ebike: "allow", shootTime: "9:00-16:00", park: "å¼ å®¶æ¹¾å¤é•‡åœè½¦åœº", desc: "è¿æ²³å¤é•‡ï¼Œæ˜æ¸…å»ºç­‘ä¿å­˜å®Œå¥½ï¼Œå†å²æ°›å›´æµ“åš" },
            { name: "å®‹åº„èƒ¡åŒç¾¤", lng: 116.795, lat: 39.942, area: "tongzhou", tag: "æ–‡è‰º|å°ä¼—", ebike: "allow", shootTime: "14:00-20:00", park: "å®‹åº„è‰ºæœ¯åŒºåœè½¦åœº", desc: "è‰ºæœ¯åŒºå‘¨è¾¹ï¼Œè‰ºæœ¯å®¶å·¥ä½œå®¤ã€ç”»å»Šå¤šï¼Œæ–‡è‰ºæ°›å›´æµ“åš" }
        ];

        // è¶…æ—¶æ£€æµ‹ï¼ˆ10ç§’ï¼‰
        setTimeout(() => {
            if (!mapLoaded) {
                mapPlaceholder.style.display = "none";
                errorTip.innerHTML = `âŒ åœ°å›¾åŠ è½½è¶…æ—¶ï¼ˆæœ¬åœ°è¿è¡Œå¸¸è§é—®é¢˜ï¼‰<br/>
                ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š<br/>
                1. ä½¿ç”¨Chromeæµè§ˆå™¨ï¼ˆå…¼å®¹æ€§æœ€ä½³ï¼‰<br/>
                2. å…³é—­å¹¿å‘Šæ‹¦æˆª/éšç§ä¿æŠ¤æ’ä»¶<br/>
                3. æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢<br/>
                ğŸ“Œ æ— éœ€æ‹…å¿ƒï¼šèƒ¡åŒåˆ—è¡¨ã€ç­›é€‰ã€å¯¼èˆªåŠŸèƒ½ä»å¯æ­£å¸¸ä½¿ç”¨`;
                errorTip.style.display = "block";
                // åˆå§‹åŒ–çº¯åˆ—è¡¨åŠŸèƒ½
                initAlleys();
            }
        }, 10000);

        // å°è¯•åˆå§‹åŒ–ç™¾åº¦åœ°å›¾
        try {
            // ç­‰å¾…ç™¾åº¦åœ°å›¾åŠ è½½
            const checkBMap = setInterval(() => {
                if (typeof BMapGL !== "undefined" && BMapGL !== null && !BMapGL.error) {
                    clearInterval(checkBMap);
                    
                    // åˆå§‹åŒ–åœ°å›¾
                    map = new BMapGL.Map("map");
                    const point = new BMapGL.Point(116.404, 39.915);
                    map.centerAndZoom(point, 14);
                    map.enableScrollWheelZoom(true);
                    map.setMapStyleV2({ styleId: "700e55c86c4f882f56d47f7d40820051" });
                    mapLoaded = true;
                    
                    // éšè—åŠ è½½å ä½
                    mapPlaceholder.style.display = "none";
                    
                    // åˆå§‹åŒ–èƒ¡åŒåˆ—è¡¨å’Œåœ°å›¾æ ‡è®°
                    initAlleys();
                }
            }, 500);
        } catch (e) {
            // åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼Œä»…åŠ è½½åˆ—è¡¨
            mapPlaceholder.style.display = "none";
            errorTip.innerHTML = `âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼š${e.message}<br/>
            ğŸ’¡ èƒ¡åŒåˆ—è¡¨ã€ç­›é€‰ã€å¯¼èˆªåŠŸèƒ½ä¸å—å½±å“ï¼Œä½ å¯ä»¥ï¼š<br/>
            1. æµè§ˆç­›é€‰èƒ¡åŒä¿¡æ¯<br/>
            2. é€‰ä¸­èƒ¡åŒåè·å–å¯¼èˆªé“¾æ¥<br/>
            3. å¤åˆ¶é“¾æ¥åˆ°æ‰‹æœºç™¾åº¦åœ°å›¾ä½¿ç”¨`;
            errorTip.style.display = "block";
            initAlleys();
        }

        // åˆå§‹åŒ–èƒ¡åŒåˆ—è¡¨å’Œæ ‡è®°
        function initAlleys() {
            const alleyList = document.getElementById("alleyList");
            alleyList.innerHTML = "";
            
            // æ¸…ç©ºæ ‡è®°
            if (mapLoaded) {
                markers.forEach(marker => map.removeOverlay(marker));
                markers = [];
            }

            alleyData.forEach(alley => {
                // åˆ›å»ºåˆ—è¡¨é¡¹
                const alleyItem = document.createElement("div");
                alleyItem.className = "alley-item";
                alleyItem.dataset.name = alley.name;
                alleyItem.dataset.area = alley.area;
                alleyItem.dataset.tag = alley.tag;
                alleyItem.dataset.ebike = alley.ebike;
                
                // æ ¼å¼åŒ–æ ‡ç­¾
                const tags = alley.tag.split("|").map(tag => `<span>${tag}</span>`).join("");
                
                alleyItem.innerHTML = `
                    <div class="alley-name">
                        ${alley.name}
                        <span class="${alley.ebike === 'allow' ? 'allow-ebike' : 'forbid-ebike'}">
                            ${alley.ebike === 'allow' ? 'âœ… å¯é€šè¡Œ' : 'âŒ ç¦é€šè¡Œ'}
                        </span>
                    </div>
                    <div class="alley-tag">
                        <span>${getAreaName(alley.area)}</span>
                        ${tags}
                        <span>æœ€ä½³æ‹æ‘„ï¼š${alley.shootTime}</span>
                    </div>
                    <div class="alley-info">
                        ğŸ…¿ï¸ åœè½¦ç‚¹ï¼š${alley.park} | ğŸ“ ç®€ä»‹ï¼š${alley.desc}
                    </div>
                `;
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                alleyItem.onclick = function() {
                    toggleAlleySelection(alley, alleyItem);
                };
                alleyList.appendChild(alleyItem);

                // åœ°å›¾æ ‡è®°ï¼ˆä»…å½“åœ°å›¾åŠ è½½æˆåŠŸæ—¶ï¼‰
                if (mapLoaded) {
                    // è‡ªå®šä¹‰å›¾æ ‡
                    const icon = new BMapGL.Icon(
                        alley.ebike === 'allow' 
                            ? "https://img.icons8.com/fluency/32/0091ff/checkmark.png" 
                            : "https://img.icons8.com/fluency/32/f53f3f/x.png",
                        new BMapGL.Size(32, 32)
                    );
                    
                    // åˆ›å»ºæ ‡è®°
                    const marker = new BMapGL.Marker(new BMapGL.Point(alley.lng, alley.lat), { icon: icon });
                    marker.setTitle(alley.name);
                    
                    // æ·»åŠ æ ‡ç­¾
                    marker.setLabel(new BMapGL.Label(
                        `${alley.name}<br/><span style="font-size:11px;color:${alley.ebike === 'allow' ? '#00b42a' : '#f53f3f'}">${alley.ebike === 'allow' ? 'ç”µåŠ¨è½¦å¯é€šè¡Œ' : 'ç”µåŠ¨è½¦ç¦è¡Œ'}</span>`, 
                        { offset: new BMapGL.Size(20, -10) }
                    ));
                    
                    // æ ‡è®°ç‚¹å‡»äº‹ä»¶
                    marker.onclick = function() {
                        const item = document.querySelector(`.alley-item[data-name="${alley.name}"]`);
                        if (item) toggleAlleySelection(alley, item);
                    };
                    
                    map.addOverlay(marker);
                    markers.push(marker);
                }
            });
            
            // æ›´æ–°é€‰ä¸­è®¡æ•°
            updateSelectedCount();
        }

        // è¾…åŠ©å‡½æ•°ï¼šè·å–åŒºåŸŸåç§°
        function getAreaName(areaCode) {
            const areaMap = {
                dongcheng: "ä¸œåŸåŒº", xicheng: "è¥¿åŸåŒº", shijingshan: "çŸ³æ™¯å±±åŒº",
                haidian: "æµ·æ·€åŒº", chaoyang: "æœé˜³åŒº", fengtai: "ä¸°å°åŒº", tongzhou: "é€šå·åŒº"
            };
            return areaMap[areaCode] || areaCode;
        }

        // åˆ‡æ¢èƒ¡åŒé€‰æ‹©çŠ¶æ€
        function toggleAlleySelection(alley, alleyItem) {
            const index = selectedAlleys.findIndex(item => item.name === alley.name);
            if (index > -1) {
                // å–æ¶ˆé€‰æ‹©
                selectedAlleys.splice(index, 1);
                alleyItem.classList.remove("selected");
            } else {
                // é€‰æ‹©
                selectedAlleys.push(alley);
                alleyItem.classList.add("selected");
            }
            // æ›´æ–°è®¡æ•°
            updateSelectedCount();
        }

        // æ›´æ–°é€‰ä¸­è®¡æ•°
        function updateSelectedCount() {
            selectedCount.textContent = `å·²é€‰æ‹©ï¼š${selectedAlleys.length} æ¡èƒ¡åŒï¼ˆè‡³å°‘é€‰æ‹©2æ¡å¯ç”Ÿæˆè·¯çº¿ï¼‰`;
            if (selectedAlleys.length >= 2) {
                selectedCount.style.color = "#00b42a";
            } else {
                selectedCount.style.color = "#2f54eb";
            }
        }

        // ç”Ÿæˆéª‘è¡Œè·¯çº¿ï¼ˆå¢å¼ºç‰ˆï¼‰
        function generateRoute() {
            if (selectedAlleys.length < 2) {
                alert("è¯·è‡³å°‘é€‰æ‹©2æ¡èƒ¡åŒè¿›è¡Œè·¯çº¿è§„åˆ’ï¼");
                return;
            }
            
            // ç”Ÿæˆè·¯çº¿è¯¦æƒ…
            let routeInfo = `### éª‘è¡Œè·¯çº¿è§„åˆ’\n\n`;
            routeInfo += `ğŸ“… æ¨èå‡ºè¡Œæ—¶é—´ï¼šç™½å¤©ï¼ˆé¿å¼€æ™šé«˜å³°ï¼‰\n`;
            routeInfo += `ğŸš´ è·¯çº¿æ€»é•¿åº¦ï¼šçº¦${(selectedAlleys.length * 1.5).toFixed(1)}å…¬é‡Œï¼ˆä¼°ç®—ï¼‰\n\n`;
            routeInfo += `### é€”ç»èƒ¡åŒï¼ˆ${selectedAlleys.length}æ¡ï¼‰\n`;
            
            selectedAlleys.forEach((alley, index) => {
                routeInfo += `${index + 1}. ${alley.name}ï¼ˆ${getAreaName(alley.area)}ï¼‰\n`;
                routeInfo += `   - ç”µåŠ¨è½¦ï¼š${alley.ebike === 'allow' ? 'âœ… å¯é€šè¡Œ' : 'âŒ ç¦é€šè¡Œï¼ˆå»ºè®®åœåœ¨'+alley.park+'ï¼‰'}\n`;
                routeInfo += `   - ç‰¹è‰²ï¼š${alley.tag.replace('|', 'ã€')}\n`;
                routeInfo += `   - æœ€ä½³æ‹æ‘„æ—¶é—´ï¼š${alley.shootTime}\n\n`;
            });
            
            const forbidAlleys = selectedAlleys.filter(a => a.ebike === "forbid");
            if (forbidAlleys.length > 0) {
                routeInfo += `### æ³¨æ„äº‹é¡¹\n`;
                routeInfo += `âš ï¸ ä»¥ä¸‹èƒ¡åŒç¦æ­¢ç”µåŠ¨è½¦é€šè¡Œï¼Œè¯·å°†è½¦è¾†åœåœ¨æŒ‡å®šä½ç½®åæ­¥è¡Œè¿›å…¥ï¼š\n`;
                forbidAlleys.forEach(alley => {
                    routeInfo += `   - ${alley.name}ï¼š${alley.park}\n`;
                });
            }
            
            // æ›´æ–°å¼¹çª—å†…å®¹
            routeContent.innerHTML = routeInfo.replace(/\n/g, '<br/>');
            
            if (!mapLoaded) {
                // åœ°å›¾æœªåŠ è½½æ—¶æ˜¾ç¤ºå¼¹çª—
                routePopup.style.display = "block";
                overlay.style.display = "block";
                alert("ğŸ“Œ åœ°å›¾æœªåŠ è½½æˆåŠŸï¼ˆæœ¬åœ°è¿è¡Œå¸¸è§ï¼‰\n\nå·²ä¸ºä½ ç”Ÿæˆè·¯çº¿è¯¦æƒ…ï¼Œå¯å¤åˆ¶åä½¿ç”¨ï¼");
                return;
            }

            // æ¸…é™¤åŸæœ‰è·¯çº¿
            if (polyline) map.removeOverlay(polyline);

            // ç”Ÿæˆè·¯çº¿ç‚¹ï¼ˆç¦è¡Œèƒ¡åŒåç§»åˆ°å…¥å£ï¼‰
            const points = selectedAlleys.map(alley => {
                const point = new BMapGL.Point(alley.lng, alley.lat);
                if (alley.ebike === "forbid") {
                    point.lat -= 0.001; // è½»å¾®åç§»
                }
                return point;
            });

            // åˆ›å»ºè·¯çº¿
            polyline = new BMapGL.Polyline(points, {
                strokeColor: "#2f54eb", 
                strokeWeight: 5, 
                strokeOpacity: 0.9,
                strokeStyle: "solid"
            });
            map.addOverlay(polyline);
            map.setViewport(points); // è‡ªé€‚åº”è§†é‡

            // æ˜¾ç¤ºè·¯çº¿å¼¹çª—
            routePopup.style.display = "block";
            overlay.style.display = "block";

            // æç¤ºç¦è¡Œèƒ¡åŒ
            if (forbidAlleys.length > 0) {
                alert(`ğŸ’¡ è·¯çº¿æç¤ºï¼š\n${forbidAlleys.map(a => `â€¢ ${a.name}`).join("\n")}\nä»¥ä¸Šèƒ¡åŒç¦æ­¢ç”µåŠ¨è½¦é€šè¡Œï¼Œè·¯çº¿å·²è§„åˆ’è‡³å…¥å£åœè½¦ç‚¹`);
            }
        }

        // å¯¼èˆªåŠŸèƒ½ï¼ˆæœ¬åœ°è¿è¡Œä¼˜åŒ–ï¼‰
        function navigate() {
            if (selectedAlleys.length < 2) {
                alert("è¯·è‡³å°‘é€‰æ‹©2æ¡èƒ¡åŒç”Ÿæˆè·¯çº¿åå†å¯¼èˆªï¼");
                return;
            }

            // ç”Ÿæˆå¯¼èˆªåæ ‡ï¼ˆç¦è¡Œèƒ¡åŒåç§»ï¼‰
            const locations = selectedAlleys.map(alley => {
                const lat = alley.ebike === "forbid" ? alley.lat - 0.001 : alley.lat;
                return `${lat},${alley.lng}`;
            }).join(";");

            // ç™¾åº¦åœ°å›¾å¯¼èˆªé“¾æ¥ï¼ˆå…¼å®¹æœ¬åœ°è¿è¡Œï¼‰
            const navUrl = `https://api.map.baidu.com/direction?origin=æˆ‘çš„ä½ç½®&destination=latlng:${locations}&mode=ebike&output=html&src=local_app`;
            
            // æœ¬åœ°è¿è¡Œé€‚é…ï¼šå¤åˆ¶é“¾æ¥+æç¤º
            try {
                navigator.clipboard.writeText(navUrl);
                alert(`âœ… å¯¼èˆªé“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\n${navUrl}\n\nğŸ“± ä½¿ç”¨æ–¹æ³•ï¼š\n1. æ‰“å¼€æ‰‹æœºç™¾åº¦åœ°å›¾\n2. ç²˜è´´é“¾æ¥åˆ°æµè§ˆå™¨æ‰“å¼€\n3. æˆ–å¤åˆ¶é“¾æ¥åˆ°ç™¾åº¦åœ°å›¾æœç´¢æ¡†`);
            } catch (e) {
                // å‰ªè´´æ¿å¤±è´¥æ—¶å¼¹çª—æ˜¾ç¤ºé“¾æ¥
                alert(`ğŸ“Œ å¯¼èˆªé“¾æ¥ï¼ˆè¯·æ‰‹åŠ¨å¤åˆ¶ï¼‰ï¼š\n${navUrl}\n\nä½¿ç”¨æç¤ºï¼šå¤åˆ¶åˆ°æ‰‹æœºç™¾åº¦åœ°å›¾æ‰“å¼€å³å¯å¯¼èˆª`);
                // å°è¯•æ‰“å¼€æ–°çª—å£
                window.open(navUrl, "_blank");
            }
        }

        // ç­›é€‰åŠŸèƒ½ï¼ˆå¢å¼ºç‰ˆï¼Œæ”¯æŒæœç´¢+å¤šæ¡ä»¶ï¼‰
        function filterAlleys() {
            const searchText = searchInput.value.toLowerCase().trim();
            const areaFilter = document.querySelector(".filter-btn[data-area].active").dataset.area;
            const tagFilter = document.querySelector(".filter-btn[data-tag].active").dataset.tag;
            const ebikeFilter = document.querySelector(".filter-btn[data-ebike].active").dataset.ebike;

            const alleyItems = document.querySelectorAll(".alley-item");
            alleyData.forEach((alley, index) => {
                // ç­›é€‰æ¡ä»¶åˆ¤æ–­
                const isAreaMatch = areaFilter === "all" || alley.area === areaFilter;
                const isTagMatch = tagFilter === "all" || alley.tag.includes(tagFilter);
                const isEbikeMatch = ebikeFilter === "all" || alley.ebike === ebikeFilter;
                // æœç´¢æ¡ä»¶åˆ¤æ–­
                const isSearchMatch = searchText === "" || 
                                      alley.name.toLowerCase().includes(searchText) || 
                                      alley.tag.toLowerCase().includes(searchText) || 
                                      getAreaName(alley.area).toLowerCase().includes(searchText) ||
                                      alley.desc.toLowerCase().includes(searchText);
                
                // æ˜¾ç¤º/éšè—åˆ—è¡¨é¡¹
                alleyItems[index].style.display = isAreaMatch && isTagMatch && isEbikeMatch && isSearchMatch ? "block" : "none";
                
                // åŒæ­¥ç­›é€‰åœ°å›¾æ ‡è®°
                if (mapLoaded && markers[index]) {
                    markers[index].setVisible(isAreaMatch && isTagMatch && isEbikeMatch && isSearchMatch);
                }
            });
        }

        // ç»‘å®šç­›é€‰æŒ‰é’®äº‹ä»¶
        function bindFilterEvents() {
            // åŒºåŸŸç­›é€‰
            document.querySelectorAll(".filter-btn[data-area]").forEach(btn => {
                btn.onclick = function() {
                    document.querySelectorAll(".filter-btn[data-area]").forEach(b => b.classList.remove("active"));
                    this.classList.add("active");
                    filterAlleys();
                };
            });

            // ç‰¹è‰²ç­›é€‰
            document.querySelectorAll(".filter-btn[data-tag]").forEach(btn => {
                btn.onclick = function() {
                    document.querySelectorAll(".filter-btn[data-tag]").forEach(b => b.classList.remove("active"));
                    this.classList.add("active");
                    filterAlleys();
                };
            });

            // ç”µåŠ¨è½¦ç­›é€‰
            document.querySelectorAll(".filter-btn[data-ebike]").forEach(btn => {
                btn.onclick = function() {
                    document.querySelectorAll(".filter-btn[data-ebike]").forEach(b => b.classList.remove("active"));
                    this.classList.add("active");
                    filterAlleys();
                };
            });

            // æœç´¢æ¡†äº‹ä»¶
            searchInput.addEventListener("input", filterAlleys);
            searchInput.addEventListener("keyup", function(e) {
                if (e.key === "Enter") filterAlleys();
            });
        }

        // ç»‘å®šå¼¹çª—äº‹ä»¶
        function bindPopupEvents() {
            // å…³é—­å¼¹çª—
            popupClose.onclick = function() {
                routePopup.style.display = "none";
                overlay.style.display = "none";
            };
            
            overlay.onclick = function() {
                routePopup.style.display = "none";
                overlay.style.display = "none";
            };
            
            // å¤åˆ¶è·¯çº¿ä¿¡æ¯
            copyRouteBtn.onclick = function() {
                const text = routeContent.innerText;
                try {
                    navigator.clipboard.writeText(text);
                    alert("âœ… è·¯çº¿ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
                } catch (e) {
                    alert("ğŸ“Œ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶è·¯çº¿ä¿¡æ¯");
                }
            };
        }

        // ç»‘å®šåŠŸèƒ½æŒ‰é’®äº‹ä»¶
        function bindFunctionEvents() {
            // æ¸…ç©ºé€‰æ‹©
            document.getElementById("clearBtn").onclick = function() {
                selectedAlleys = [];
                document.querySelectorAll(".alley-item").forEach(item => item.classList.remove("selected"));
                if (mapLoaded && polyline) {
                    map.removeOverlay(polyline);
                    polyline = null;
                }
                updateSelectedCount();
            };

            // ç”Ÿæˆè·¯çº¿
            document.getElementById("routeBtn").onclick = generateRoute;
            
            // å¯¼èˆªå‡ºå‘
            document.getElementById("navBtn").onclick = navigate;
        }

        // åˆå§‹åŒ–æ‰€æœ‰äº‹ä»¶ç»‘å®š
        bindFilterEvents();
        bindFunctionEvents();
        bindPopupEvents();
        
        // åˆå§‹åŒ–èƒ¡åŒåˆ—è¡¨
        initAlleys();
    </script>
</body>
</html>